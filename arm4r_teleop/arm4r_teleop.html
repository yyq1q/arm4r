<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ROS2 Arrow Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    .btn {
      width:  300px;   
      height: 300px;  
      font-size: 3em; 
      margin: 10px;   
      cursor: pointer;
    }
    .row { display: flex; justify-content: center; }

    input[type="range"] {
      width: 80%;
      height: 40px;
      accent-color: #007bff;
    }

    /* Chrome/Edgeç”¨: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã¤ã¾ã¿ã‚’å¤§ãã */
    input[type="range"]::-webkit-slider-thumb {
      width:  40px;
      height: 40px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #333;
    }

    /* Firefoxç”¨ */
    input[type="range"]::-moz-range-thumb {
      width:  40px;
      height: 40px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <h1>Controller</h1>

  <!-- é€ä¿¡é€Ÿåº¦è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã•ã‚‰ã«å¤§ãã -->
  <div id="speedDisplay" style="font-size:1.5em; margin-bottom:30px; font-weight:bold;">
    é€Ÿåº¦: linear=0.0, è§’é€Ÿåº¦=0.0
  </div>

  <!-- é€Ÿåº¦èª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¿½åŠ  -->
  <div style="margin: 30px 0;">
    <!-- <label for="speedSlider" style="font-size:2em;">é€Ÿåº¦èª¿æ•´</label><br> -->
    <span id="speedValue" style="font-size:2em;">0.5</span>
    <div>
        <input type="range" id="speedSlider" min="0.1" max="1.0" step="0.1" value="0.5">
    </div>
  </div>

  <div class="row">
    <button class="btn"
      style="font-size:7em;"
      ontouchstart="touchSetActive(event, 'turn_left')" onmousedown="setActive('turn_left')"
      ontouchend="touchClearActive(event, 'turn_left')" onmouseup="clearActive('turn_left')">âŸ²</button>
    <button class="btn"
      ontouchstart="touchSetActive(event, 'up')" onmousedown="setActive('up')"
      ontouchend="touchClearActive(event, 'up')" onmouseup="clearActive('up')">â†‘</button>
    <button class="btn"
      style="font-size:7em;"
      ontouchstart="touchSetActive(event, 'turn_right')" onmousedown="setActive('turn_right')"
      ontouchend="touchClearActive(event, 'turn_right')" onmouseup="clearActive('turn_right')">âŸ³</button>
  </div>
  <div class="row">
    <button class="btn"
      ontouchstart="touchSetActive(event, 'left')" onmousedown="setActive('left')"
      ontouchend="touchClearActive(event, 'left')" onmouseup="clearActive('left')">â†</button>
    <button class="btn" onclick="sendCmd(0,0,0)">â– </button>
    <button class="btn"
      ontouchstart="touchSetActive(event, 'right')" onmousedown="setActive('right')"
      ontouchend="touchClearActive(event, 'right')" onmouseup="clearActive('right')">â†’</button>
  </div>
  <div class="row">
    <button class="btn"
      ontouchstart="touchSetActive(event, 'down')" onmousedown="setActive('down')"
      ontouchend="touchClearActive(event, 'down')" onmouseup="clearActive('down')">â†“</button>
  </div>

  <div class="row">
    <button class="btn"
      style="font-size:7em;"
      ontouchstart="poseZUP()">â†</button>
    <span id="poseZValue" style="font-size:3em; margin: 0 30px;">z=0.0</span>
    <button class="btn"
      style="font-size:7em;"
      ontouchstart="poseZDown()">â†’</button>
  </div>

  <script>
    // Raspberry Pi ã® IP ã«ç½®ãæ›ãˆã‚‹
    var ros = new ROSLIB.Ros({
      url : 'ws://192.168.0.8:9090'
    });

    ros.on('connection', function() {
      console.log('âœ… Connected to websocket server.');
    });

    ros.on('error', function(error) {
      console.error('âŒ Error connecting:', error);
    });

    ros.on('close', function() {
      console.log('ğŸ”Œ Connection closed.');
    });

    // Publisherï¼ˆTwistå‹ï¼‰
    var cmdVel = new ROSLIB.Topic({
      ros : ros,
      name : '/cmd_vel',
      messageType : 'geometry_msgs/Twist'
    });

    // Pose Publisherè¿½åŠ 
    var posePub = new ROSLIB.Topic({
      ros : ros,
      name : '/body_pose',
      messageType : 'geometry_msgs/Pose'
    });

    // æŠ¼ã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆæ—‹å›è¿½åŠ ï¼‰
    let pressed = { up: false, down: false, left: false, right: false, turn_left: false, turn_right: false };

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤å–å¾—
    function getSpeed() {
      return parseFloat(document.getElementById('speedSlider').value);
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤è¡¨ç¤ºæ›´æ–°
    document.getElementById('speedSlider').addEventListener('input', function() {
      document.getElementById('speedValue').textContent = this.value;
    });

    // åˆç®—ã—ã¦cmd_velé€ä¿¡ï¼ˆå¹³è¡Œç§»å‹•ï¼‹æ—‹å›å¯¾å¿œï¼‰
    function sendCombinedCmd() {
      let linear_x = 0;
      let linear_y = 0;
      let angular_z = 0;
      const speed = getSpeed(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’å–å¾—
      if (pressed.up)        linear_x += speed;
      if (pressed.down)      linear_x -= speed;
      if (pressed.left)      linear_y += speed;
      if (pressed.right)     linear_y -= speed;
      if (pressed.turn_left)  angular_z += speed;
      if (pressed.turn_right) angular_z -= speed;

      var twist = new ROSLIB.Message({
        linear: { x: linear_x, y: linear_y, z: 0 },
        angular: { x: 0, y: 0, z: angular_z }
      });
      cmdVel.publish(twist);
      updateSpeedDisplay(linear_x, linear_y, angular_z);
      console.log(`ğŸ“¨ Sent: linear_x=${linear_x}, linear_y=${linear_y}, è§’é€Ÿåº¦=${angular_z}`);
    }

    // é€ä¿¡é€Ÿåº¦è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆå¹³è¡Œç§»å‹•ï¼‹æ—‹å›å¯¾å¿œï¼‰
    function updateSpeedDisplay(linear_x, linear_y, angular_z) {
      document.getElementById('speedDisplay').textContent =
        `é€Ÿåº¦: x=${linear_x.toFixed(1)}, y=${linear_y.toFixed(1)}, è§’é€Ÿåº¦=${angular_z.toFixed(1)}`;
    }

    // Poseé€ä¿¡é–¢æ•°ï¼ˆä¾‹: x, y, z, yawã‚’æŒ‡å®šã—ã¦é€ä¿¡ï¼‰
    function sendPose(x, y, z, yaw) {
      // yawã‹ã‚‰ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³è¨ˆç®—
      const halfYaw = yaw / 2;
      const qz = Math.sin(halfYaw);
      const qw = Math.cos(halfYaw);

      var poseMsg = new ROSLIB.Message({
        position: { x: x, y: y, z: z },
        orientation: { x: 0, y: 0, z: qz, w: qw }
      });
      posePub.publish(poseMsg);
      console.log(`ğŸ“¨ Pose sent: x=${x}, y=${y}, z=${z}, yaw=${yaw}`);
    }

    // ä¾‹: ãƒœã‚¿ãƒ³ã§Poseé€ä¿¡ï¼ˆå¿…è¦ã«å¿œã˜ã¦UIè¿½åŠ ï¼‰
    // <button class="btn" onclick="sendPose(1,0,0,0)">Poseé€ä¿¡</button>

    // æ“ä½œçŠ¶æ…‹ç®¡ç†
    let activeBtn = null;

    function setActive(dir) {
      pressed[dir] = true;
      sendCombinedCmd();
    }

    function clearActive(dir) {
      pressed[dir] = false;
      sendCombinedCmd();
    }

    function touchSetActive(event, dir) {
      event.preventDefault();
      setActive(dir);
    }

    function touchClearActive(event, dir) {
      event.preventDefault();
      clearActive(dir);
    }

    // å®šæœŸçš„ã«åˆç®—å€¤é€ä¿¡
    setInterval(sendCombinedCmd, 200);

    let pose = { x: 0, y: 0, z: 0, yaw: 0 }; // poseå€¤ã‚’ç®¡ç†

    function updatePoseZValue() {
      document.getElementById('poseZValue').textContent = `z=${pose.z.toFixed(2)}`;
    }

    // poseZUP/poseZDownã§å€¤æ›´æ–°
    function poseZDown() {
      pose.z -= 0.05;
      sendPose(pose.x, pose.y, pose.z, pose.yaw);
      updatePoseZValue();
    }

    function poseZUP() {
      pose.z += 0.05;
      sendPose(pose.x, pose.y, pose.z, pose.yaw);
      updatePoseZValue();
    }

    function resizeButtons() {
      // ç”»é¢å¹…ãƒ»é«˜ã•ã‚’å–å¾—
      const w = window.innerWidth;
      const h = window.innerHeight;
      // ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆä¾‹: ç”»é¢å¹…ã®1/4ã€é«˜ã•ã®1/4ï¼‰
      const size = Math.min(w, h) / 4;
      // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—ã—ã¦ã‚µã‚¤ã‚ºå¤‰æ›´
      document.querySelectorAll('.btn').forEach(btn => {
        btn.style.width = size + 'px';
        btn.style.height = size + 'px';
        btn.style.fontSize = (size * 0.3) + 'px';
      });
      // é€Ÿåº¦è¡¨ç¤ºã‚‚èª¿æ•´
      document.getElementById('speedDisplay').style.fontSize = (size * 0.2) + 'px';
    }
    // åˆå›ãƒ»ãƒªã‚µã‚¤ã‚ºæ™‚ã«å®Ÿè¡Œ
    window.addEventListener('resize', resizeButtons);
    window.addEventListener('DOMContentLoaded', () => {
      resizeButtons();
      updatePoseZValue();
    });
  </script>
</body>
</html>
